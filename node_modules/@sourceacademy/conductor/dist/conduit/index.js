import{C as s}from"../ConductorInternalError-Bfjhowsx.js";export{C as ChannelQueue}from"../ChannelQueue-Bmt4Qwn3.js";import"../ConductorError-C5tld8jg.js";import"../common/ds/index.js";class t{name;t;i=new Set;h=!0;o=[];send(s,t){this.l(),this.t.postMessage(s,t??[])}subscribe(s){if(this.l(),this.i.add(s),this.o){for(const t of this.o)s(t);delete this.o}}unsubscribe(s){this.l(),this.i.delete(s)}close(){this.l(),this.h=!1,this.t?.close()}l(){if(!this.h)throw new s(`Channel ${this.name} has been closed`)}_(s){if(this.l(),this.o){if(this.o.length>=10)return console.warn("Channel buffer full; message dropped (no subscribers on channel)",s);this.o.push(s)}else for(const t of this.i)t(s)}listenToPort(s){s.addEventListener("message",s=>this._(s.data)),s.start()}replacePort(s){this.l(),this.t?.close(),this.t=s,this.listenToPort(s)}constructor(s,t){this.name=s,this.replacePort(t)}}class i{u=!0;p;m;C=new Map;P=new Map;v=[];M(s){const{port1:i,port2:e}=new MessageChannel,h=new t(s,i);this.p.postMessage([s,e],[e]),this.C.set(s,h)}l(){if(!this.u)throw new s("Conduit already terminated")}registerPlugin(t,...i){this.l();const e=[];for(const s of t.channelAttach)this.C.has(s)||this.M(s),e.push(this.C.get(s));const h=new t(this,e,...i);if(void 0!==h.name){if(this.P.has(h.name))throw new s(`Plugin ${h.name} already registered`);this.P.set(h.name,h)}return this.v.push(h),h}unregisterPlugin(s){this.l();let t=0;for(let i=0;i<this.v.length;++i)this.v[t]===s&&++t,this.v[i]=this.v[i+t];for(let s=this.v.length-1,i=this.v.length-t;s>=i;--s)delete this.v[s];s.name&&this.P.delete(s.name),s.destroy?.()}lookupPlugin(t){if(this.l(),!this.P.has(t))throw new s(`Plugin ${t} not registered`);return this.P.get(t)}terminate(){this.l();for(const s of this.v)s.destroy?.();this.p.terminate?.(),this.u=!1}j(s){const[i,e]=s;if(this.C.has(i)){const s=this.C.get(i);this.m?s.listenToPort(e):s.replacePort(e)}else{const s=new t(i,e);this.C.set(i,s)}}constructor(s,t=!1){this.p=s,s.addEventListener("message",s=>this.j(s.data)),this.m=t}}export{t as Channel,i as Conduit};
//# sourceMappingURL=index.js.map
